<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>全员可见的视频库</title>
  <style>
    body { padding: 20px; max-width: 1200px; margin: 0 auto; font-family: Arial; }
    .upload-area { margin: 20px 0; padding: 20px; border: 1px dashed #ccc; }
    .file-list { margin-top: 30px; }
    .file-item { padding: 10px; border-bottom: 1px solid #eee; margin: 10px 0; }
    .video-preview { max-width: 400px; margin: 10px 0; }
    .success { color: #2ecc71; }
    .error { color: #e74c3c; }
  </style>
</head>
<body>
  <h1>全员可见的视频上传与展示</h1>

  <!-- 上传区域 -->
  <div class="upload-area">
    <h3>上传视频</h3>
    <input type="file" id="fileInput" accept="video/*">
    <button id="uploadBtn">上传</button>
    <div id="uploadResult" class="success"></div>
  </div>

  <!-- 所有文件展示区域 -->
  <div class="file-list">
    <h3>所有上传的视频（全员可见）</h3>
    <div id="fileListContainer"></div>
  </div>

  <script>
    // 页面加载时自动获取所有文件
    window.onload = async () => {
      await loadAllFiles();
    };

    // 1. 上传视频
    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const resultDiv = document.getElementById('uploadResult');
      
      if (!fileInput.files.length) {
        resultDiv.textContent = '请选择视频文件！';
        resultDiv.className = 'error';
        return;
      }

      const file = fileInput.files[0];
      resultDiv.textContent = '正在上传...';
      resultDiv.className = '';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          resultDiv.textContent = `上传成功！${data.name}`;
          resultDiv.className = 'success';
          fileInput.value = ''; // 清空选择
          await loadAllFiles(); // 上传后刷新文件列表
        } else {
          resultDiv.textContent = `上传失败：${data.error}`;
          resultDiv.className = 'error';
        }
      } catch (error) {
        resultDiv.textContent = `上传出错：${error.message}`;
        resultDiv.className = 'error';
      }
    });

    // 2. 加载所有文件
    async function loadAllFiles() {
      const container = document.getElementById('fileListContainer');
      container.innerHTML = '正在加载文件列表...';

      try {
        const response = await fetch('/api/get-all-files');
        const data = await response.json();

        if (data.success && data.files.length > 0) {
          // 渲染所有文件
          container.innerHTML = data.files.map(file => `
            <div class="file-item">
              <div>文件名：${file.name}</div>
              <div>大小：${formatFileSize(file.size)}</div>
              <div>上传时间：${file.uploadTime}</div>
              <video class="video-preview" controls src="${file.url}"></video>
              <div>访问链接：<a href="${file.url}" target="_blank">${file.url}</a></div>
            </div>
          `).join('');
        } else {
          container.innerHTML = '暂无上传的视频';
        }
      } catch (error) {
        container.innerHTML = `加载失败：${error.message}`;
      }
    }

    // 辅助函数：格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / 1048576).toFixed(2) + ' MB';
    }
  </script>
</body>
</html>
